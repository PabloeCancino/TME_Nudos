name: Test Suite

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  test:
    name: Run Lean Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install elan
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH
        
    - name: Display Lean environment
      run: |
        echo "Lean toolchain: $(cat lean-toolchain)"
        lean --version
        lake --version
        echo "Working directory: $(pwd)"
        
    - name: Cache Lean dependencies
      uses: actions/cache@v4
      with:
        path: .lake
        key: ${{ runner.os }}-lake-test-${{ hashFiles('lake-manifest.json') }}
        restore-keys: |
          ${{ runner.os }}-lake-test-
          ${{ runner.os }}-lake-
          
    - name: Download Mathlib cache
      run: |
        lake exe cache get || true
        
    - name: Build project
      run: |
        lake build
        
    - name: Test main module
      run: |
        echo "Testing main TMENudos module..."
        lake env lean TMENudos.lean
        echo "âœ… Main module compiles successfully"
        
    - name: Test individual modules
      run: |
        echo "Testing individual Lean modules..."
        for file in TMENudos/TCN_*.lean; do
          if [ -f "$file" ]; then
            echo "Testing $file..."
            lake env lean "$file" && echo "âœ… $file OK" || echo "âŒ $file FAILED"
          fi
        done
        
    - name: Verify test files
      run: |
        echo "Checking for test files..."
        TEST_FILES=$(find TMENudos -name "*Test*.lean" -o -name "*test*.lean")
        if [ -n "$TEST_FILES" ]; then
          echo "Found test files:"
          echo "$TEST_FILES"
          for file in $TEST_FILES; do
            echo "Running $file..."
            lake env lean "$file" && echo "âœ… $file passed" || echo "âŒ $file failed"
          done
        else
          echo "No explicit test files found"
        fi
        
    - name: Verify proof completeness
      run: |
        echo "Verifying all proofs are complete..."
        echo "Searching for 'sorry' statements in source files..."
        
        SORRY_COUNT=$(grep -r "sorry" TMENudos/*.lean | wc -l || echo "0")
        
        if [ "$SORRY_COUNT" -eq 0 ]; then
          echo "âœ… SUCCESS: All proofs are complete! No sorry statements found."
          echo "status=complete" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ WARNING: Found $SORRY_COUNT incomplete proof(s)"
          grep -n "sorry" TMENudos/*.lean | head -10
          echo "status=incomplete" >> $GITHUB_OUTPUT
        fi
        
    - name: Generate test report
      if: always()
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Module Compilation Status" >> $GITHUB_STEP_SUMMARY
        echo "- Main module: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Test suite: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        SORRY_COUNT=$(grep -r "sorry" TMENudos/*.lean 2>/dev/null | wc -l || echo "0")
        if [ "$SORRY_COUNT" -eq 0 ]; then
          echo "### âœ… Proof Verification" >> $GITHUB_STEP_SUMMARY
          echo "All proofs are formally verified and complete!" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ Proof Status" >> $GITHUB_STEP_SUMMARY
          echo "Found $SORRY_COUNT incomplete proof(s) requiring attention" >> $GITHUB_STEP_SUMMARY
        fi
